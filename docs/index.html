<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.47">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>C-PATH / JH guide to getting started with OMOP for CURE ID – CURE ID</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">CURE ID</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#welcome" id="toc-welcome" class="nav-link active" data-scroll-target="#welcome">Welcome</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a></li>
  <li><a href="#cure-id-technical-support-checklist" id="toc-cure-id-technical-support-checklist" class="nav-link" data-scroll-target="#cure-id-technical-support-checklist">CURE ID technical support checklist</a></li>
  <li><a href="#omop-extract-transform-and-load-guide" id="toc-omop-extract-transform-and-load-guide" class="nav-link" data-scroll-target="#omop-extract-transform-and-load-guide">OMOP Extract, Transform, and Load Guide</a>
  <ul class="collapse">
  <li><a href="#ohdsi-etl-resources" id="toc-ohdsi-etl-resources" class="nav-link" data-scroll-target="#ohdsi-etl-resources"><u>OHDSI ETL Resources</u></a></li>
  <li><a href="#ohdsi-etl-steps" id="toc-ohdsi-etl-steps" class="nav-link" data-scroll-target="#ohdsi-etl-steps"><u>OHDSI ETL Steps</u></a></li>
  <li><a href="#places-to-connect" id="toc-places-to-connect" class="nav-link" data-scroll-target="#places-to-connect"><u>Places to Connect</u></a></li>
  </ul></li>
  <li><a href="#omop-cohort-creation-and-de-identification-guide" id="toc-omop-cohort-creation-and-de-identification-guide" class="nav-link" data-scroll-target="#omop-cohort-creation-and-de-identification-guide">OMOP Cohort Creation and De-identification Guide</a>
  <ul class="collapse">
  <li><a href="#concept-table-creation-script" id="toc-concept-table-creation-script" class="nav-link" data-scroll-target="#concept-table-creation-script"><u>00 – Concept Table Creation Script</u></a></li>
  <li><a href="#cohort-creation-script" id="toc-cohort-creation-script" class="nav-link" data-scroll-target="#cohort-creation-script"><u>01 – Cohort Creation Script</u></a></li>
  <li><a href="#cure-id-tables-script" id="toc-cure-id-tables-script" class="nav-link" data-scroll-target="#cure-id-tables-script"><u>02 – CURE ID Tables Script</u></a></li>
  <li><a href="#replace-rare-conditions-script" id="toc-replace-rare-conditions-script" class="nav-link" data-scroll-target="#replace-rare-conditions-script"><u>03 – Replace Rare Conditions Script</u></a></li>
  <li><a href="#deidentified-data-ddl-script" id="toc-deidentified-data-ddl-script" class="nav-link" data-scroll-target="#deidentified-data-ddl-script"><u>04 – Deidentified Data DDL Script</u></a></li>
  <li><a href="#deidentification-script" id="toc-deidentification-script" class="nav-link" data-scroll-target="#deidentification-script"><u>05 – Deidentification Script</u></a></li>
  <li><a href="#quality-checks-script-optional" id="toc-quality-checks-script-optional" class="nav-link" data-scroll-target="#quality-checks-script-optional"><u>06 – Quality Checks Script (optional)</u></a></li>
  <li><a href="#cohort-profile-scripts" id="toc-cohort-profile-scripts" class="nav-link" data-scroll-target="#cohort-profile-scripts"><u>07 – Cohort Profile Scripts</u></a></li>
  </ul></li>
  <li><a href="#cure-id-profile-scripts-output-interpretation" id="toc-cure-id-profile-scripts-output-interpretation" class="nav-link" data-scroll-target="#cure-id-profile-scripts-output-interpretation">CURE ID Profile Scripts – Output &amp; Interpretation</a>
  <ul class="collapse">
  <li><a href="#a_condition_profile.sql" id="toc-a_condition_profile.sql" class="nav-link" data-scroll-target="#a_condition_profile.sql">07_A_condition_profile.sql</a></li>
  <li><a href="#b_measurement_profile.sql" id="toc-b_measurement_profile.sql" class="nav-link" data-scroll-target="#b_measurement_profile.sql">07_B_measurement_profile.sql</a></li>
  <li><a href="#c_drug_exposure_profile.sql" id="toc-c_drug_exposure_profile.sql" class="nav-link" data-scroll-target="#c_drug_exposure_profile.sql">07_C_drug_exposure_profile.sql</a></li>
  <li><a href="#e_device_profile.sql" id="toc-e_device_profile.sql" class="nav-link" data-scroll-target="#e_device_profile.sql">07_E_device_profile.sql</a></li>
  </ul></li>
  <li><a href="#omop-table-and-field-basics" id="toc-omop-table-and-field-basics" class="nav-link" data-scroll-target="#omop-table-and-field-basics">OMOP Table and Field Basics</a></li>
  <li><a href="#cure-id-concept-mapping-support" id="toc-cure-id-concept-mapping-support" class="nav-link" data-scroll-target="#cure-id-concept-mapping-support">Cure ID Concept Mapping Support</a></li>
  <li><a href="#identifying-oxygen-devices-in-epicclarity" id="toc-identifying-oxygen-devices-in-epicclarity" class="nav-link" data-scroll-target="#identifying-oxygen-devices-in-epicclarity">Identifying Oxygen Devices in Epic/Clarity</a></li>
  <li><a href="#geocoding-and-integrating-sdoh-data" id="toc-geocoding-and-integrating-sdoh-data" class="nav-link" data-scroll-target="#geocoding-and-integrating-sdoh-data">Geocoding and Integrating SDOH Data</a>
  <ul class="collapse">
  <li><a href="#geocoding" id="toc-geocoding" class="nav-link" data-scroll-target="#geocoding">Geocoding</a></li>
  <li><a href="#area-deprivation-index" id="toc-area-deprivation-index" class="nav-link" data-scroll-target="#area-deprivation-index">Area Deprivation Index</a></li>
  <li><a href="#adi-as-an-ohdsi-concept" id="toc-adi-as-an-ohdsi-concept" class="nav-link" data-scroll-target="#adi-as-an-ohdsi-concept">ADI as an OHDSI Concept</a></li>
  </ul></li>
  <li><a href="#ohdsi-tool-suite" id="toc-ohdsi-tool-suite" class="nav-link" data-scroll-target="#ohdsi-tool-suite">OHDSI Tool Suite</a></li>
  <li><a href="#best-practices" id="toc-best-practices" class="nav-link" data-scroll-target="#best-practices">Best Practices</a></li>
  <li><a href="#manuscripts" id="toc-manuscripts" class="nav-link" data-scroll-target="#manuscripts">Manuscripts</a></li>
  <li><a href="#webinars" id="toc-webinars" class="nav-link" data-scroll-target="#webinars">Webinars</a></li>
  <li><a href="#omop-scripts-for-epic" id="toc-omop-scripts-for-epic" class="nav-link" data-scroll-target="#omop-scripts-for-epic">OMOP Scripts for Epic</a></li>
  <li><a href="#using-synthetic-data" id="toc-using-synthetic-data" class="nav-link" data-scroll-target="#using-synthetic-data">Using synthetic data</a></li>
  <li><a href="#useful-resources" id="toc-useful-resources" class="nav-link" data-scroll-target="#useful-resources">Useful Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">C-PATH / JH guide to getting started with OMOP for CURE ID</h1>
</div>



<div class="quarto-title-meta">

    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">June 24, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="welcome" class="level2">
<h2 class="anchored" data-anchor-id="welcome">Welcome</h2>
<p>This site is designed to provide guidance, scripts and resources for sites transitioning data to OMOP common data model as part of CURE ID.</p>
<p>CURE ID is a platform designed and developed by the US Food and Drug Administration (FDA) and the National Institutes of Health (NIH) National Center for Translational Sciences (NCATS) to capture real world data (RWD) about how existing drugs are used in new ways (e.g., drug repurposing) to treat diseases of high unmet clinical need. The documentation on this site is part of a project funded by the US Department of Health and Human Services (HHS) Assistant Secretary for Planning and Evaluation (ASPE)’s Patient-Centered Outcomes Research Trust Fund (under Interagency Agreement #75F40121S35006) to develop and disseminate tools facilitating the extraction of RWD from the electronic health record (EHR).</p>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The goals of OMOP are to gain better understanding of human health by improving our ability to analyze observational health data.</p>
<p>Health data is stored by individual health systems in unique ways which limits the ability to collaborate and learn from larger populations. This is a problem because certain clinical conditions are infrequent and it is important to have sufficient number of cases to perform statistical tests. De-identified data shared across institutions has the promise of allowing scientists to develop important insights about health which is the motivation to enable greater collaboration.</p>
<section id="what-is-a-common-data-model" class="level4">
<h4 class="anchored" data-anchor-id="what-is-a-common-data-model">What is a common data model?</h4>
<p>A common data model (CDM) allows multiple health care systems with their individual databases to join forces creating greater populations which can power more compelling scientific studies. A simple way to think about this is the difficulty of finding the silverware drawer in a new kitchen – if there is a unifying rule for where the silverware drawer is located in every kitchen (immediately to right of the sink) it makes it possible to find this much easier. A common data model creates a system so that data elements like “systolic blood pressure” or “sepsis” are recorded and organized in the same way. OMOP stands for Observational Medical Outcomes Partnership and is the common data model of the <a href="https://www.ohdsi.org/">Observational Health Data Sciences and Informatics</a> program.</p>
</section>
<section id="what-is-an-etl" class="level4">
<h4 class="anchored" data-anchor-id="what-is-an-etl">What is an ETL?</h4>
<p>ETL stands for Extract, Transform, and Load. [The Book of OHDSI, Chapter 6] (https://ohdsi.github.io/TheBookOfOhdsi/ExtractTransformLoad.html) states:</p>
<p>“In order to get from the native/raw data to the OMOP Common Data Model (CDM) we have to create an extract, transform, and load (ETL) process. This process should restructure the data to the CDM, and add mappings to the Standardized Vocabularies, and is typically implemented as a set of automated scripts, for example SQL scripts. It is important that this ETL process is repeatable, so that it can be rerun whenever the source data is refreshed.</p>
<p>Creating an ETL is usually a large undertaking. Over the years, we have developed best practices, consisting of four major steps:</p>
<ol type="1">
<li><p>Data experts and CDM experts together design the ETL.</p></li>
<li><p>People with medical knowledge create the code mappings.</p></li>
<li><p>A technical person implements the ETL.</p></li>
<li><p>All are involved in quality control.”</p></li>
</ol>
</section>
</section>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting started</h2>
<p>The code for the CURE ID project is hosted on <a href="https://github.com/">GitHub</a>. GitHub is a web-based platform that allows developers to host, review, and collaborate on code repositories. It is widely used for version control and source code management, and it provides features such as issue tracking, wikis, and project management tools to facilitate team collaboration.&nbsp;</p>
<p>The repository containing the code and concept sets can be accessed at <a href="https://github.com/OHDSI/CureIdRegistry">OHDSI/CureIdRegistry</a> There are four branches within the repository that differ only in the clinical variables included in the cohort curation scripts. Be sure to select the appropriate branch based on individual health system data and ETL capacity:</p>
<ol type="1">
<li>Main branch: fundamental set of variables for Registry submission - demographics, comorbidities, vitals, labs, medications, vaccinations, oxygen devices, viral assays, and COVID complications.</li>
<li>Refresh Basic: the main branch variables with additional concepts to allow for Charlson Comorbidity Index calculation</li>
<li>Refresh Advanced: the refresh basic branch variables with additional concepts for Area Deprivation Index calculation (this branch requires Geocoding patient addresses to determine Census Blocks)</li>
<li>Main CDM v5.3: this is the same set of variables included in the main branch but with cohort curation scripts written for the OMOP CDM version 5.3 (there are four fields names that changed from version 5.3 to 5.4)</li>
</ol>
</section>
<section id="cure-id-technical-support-checklist" class="level2">
<h2 class="anchored" data-anchor-id="cure-id-technical-support-checklist">CURE ID technical support checklist</h2>
<ol type="1">
<li>Core site team identified and technical kickoff call scheduled</li>
<li>Determine feasibility of using OHDSI tools</li>
<li>If using OHDSI tools is not possible, has the site determined a path forward, for example using scripts already developed by other sites?</li>
<li>Members of core team send proof of course completion to technical team for the following free courses:
<ul>
<li><a href="https://view.genially.com/667178efe55dd50015cd9de5">Course: CURE ID</a></li>
<li><a href="https://academy.ehden.eu/course/view.php?id=4">OMOP CDM and Standardised Vocabularies (ehden.eu)</a></li>
<li><a href="https://academy.ehden.eu/course/view.php?id=7">Extract, Transform and Load (ehden.eu)</a></li>
</ul></li>
<li>Site Completes CURE ID Manual OMOP Data Mapping Template</li>
<li>The technical team reviews steps for performing ETL process by walking through GitHub scripts</li>
<li>Meetings with JHU software contractors arranged, if needed</li>
<li>Site confirms that they are using most recent GitHub scripts before proceeding</li>
<li>Data Quality Dashboard Run</li>
<li>JSON and script output sent to Danielle Boyce</li>
<li>DQD and concept counts approved or issues identified and reviewed with technical team</li>
<li>DQD and concept counts re-run and approved by JHU technical team</li>
<li>Run CURE ID scripts (see OMOP Cohort Creation and De-identification Guide)</li>
<li>De-identified data exported to CSV file</li>
<li>JHU/C-Path technical team reviews CSV files before transfer</li>
<li>Any caveats in the data documented in Data Export Cover Sheet</li>
<li>Data transfer arrangements made by contacting Smitty Heavner</li>
</ol>
</section>
<section id="omop-extract-transform-and-load-guide" class="level2">
<h2 class="anchored" data-anchor-id="omop-extract-transform-and-load-guide">OMOP Extract, Transform, and Load Guide</h2>
<section id="ohdsi-etl-resources" class="level3">
<h3 class="anchored" data-anchor-id="ohdsi-etl-resources"><u>OHDSI ETL Resources</u></h3>
<ul>
<li><a href="https://www.ohdsi.org/web/wiki/doku.php?id=documentation:etl_best_practices">OHDSI Wiki: ETL Creation Best Practices</a></li>
<li><a href="Book of OHDSI - Ch.6 Extract Transform Load">Book of OHDSI (Ch. 6): Extract Transform Load</a></li>
<li><a href="https://academy.ehden.eu/enrol/index.php?id=4">EHDEN Academy: OMOP CDM and Standardised Vocabularies</a></li>
<li><a href="https://academy.ehden.eu/course/view.php?id=7">EHDEN Academy: Extract, Transform and Load</a></li>
<li><a href="https://academy.ehden.eu/enrol/index.php?id=18">EHDEN Academy: Introduction to Usagi &amp; Code Mappings for an ETL</a></li>
</ul>
</section>
<section id="ohdsi-etl-steps" class="level3">
<h3 class="anchored" data-anchor-id="ohdsi-etl-steps"><u>OHDSI ETL Steps</u></h3>
<ol type="1">
<li><p><strong>Find your people.</strong></p>
<ol type="a">
<li>Assemble ETL team: both data experts, medical experts, CDM/vocabulary experts</li>
<li>Assign persons with medical knowledge to create code mappings</li>
<li>Assign persons with technical knowledge to implement the ETL</li>
<li>Schedule regular meetings for quality control maintenance</li>
</ol></li>
<li><p><strong>Understand your data.</strong></p>
<ol type="a">
<li>Take inventory of source data (tools: <a href="https://github.com/OHDSI/WhiteRabbit">White Rabbit</a>)
<ol type="i">
<li>List of tables in database</li>
<li>List fields in each table</li>
<li>List distinct values of each field</li>
<li>Summarize the frequency of each value of each field.</li>
</ol></li>
<li>Define relationships between source data tables and fields (tools: <a href="https://github.com/OHDSI/WhiteRabbit">Rabbit-in-a-Hat</a>)
<ol type="i">
<li>Record both relationship definition decisions and reasoning behind these decisions</li>
</ol></li>
<li>Determine standardized vocabularies that already exist in your source data (ICD-10, CPT, HCPCS, LOINC, etc.)
<ol type="i">
<li>Many commonly used standardized coding systems have already been mapped to the OMOP vocabulary – utilize the work done by others across the OHDSI community to accelerate the process of mapping your data systems to OMOP.</li>
</ol></li>
<li>Determine the coding systems in your source data that are proprietary or not already mapped to OMOP (proprietary patient/visit identifiers, account numbers, charge codes, etc.)</li>
</ol></li>
<li><p><strong>Map your codes to OMOP concepts.</strong></p>
<ol type="a">
<li>Summarize the frequency of each code from your source data code sets that will require mapping to OMOP concepts.</li>
<li>Create your source data to OMOP mapping. (tools: <a href="https://github.com/OHDSI/Usagi">Usagi</a>)
<ol type="i">
<li>Assign this task to the ETL team members with appropriate medical knowledge to discern which codes are most synonymous based on their descriptions. Medical knowledge is key for this step as semantic understanding of clinical descriptions is required to make decisions on mapping source data concepts to OMOP concepts.</li>
<li>Start with the most frequently used codes and determine your threshold of code frequency to include in the mapping.</li>
<li>Focus on a particular project or clinical domain to limit the scope of data needed for capture and conversion to OMOP.</li>
<li>Utilize the Usagi tool for mapping suggestions and searching based on similarity of code descriptions.</li>
</ol></li>
</ol></li>
<li><p><strong>OMOPify your data!</strong></p>
<ol type="a">
<li>Determine the technology and software used or approved at your site for data storage, querying, and transfer. Determine the tools and technologies that team members and internal staff have expertise in.</li>
<li>Generate the OMOP DDLs
<ol type="i">
<li>Using R: https://github.com/OHDSI/CommonDataModel</li>
<li>Using SQL: https://github.com/OHDSI/CommonDataModel/tree/v5.4.0/inst/ddl/5.4</li>
</ol></li>
<li>Implement the ETL.
<ol type="i">
<li>Assign this task to the ETL team members with technical knowledge and permission for accessing and extracting source data and writing to a database.</li>
<li>Many tools and technologies can be used for this step. Utilize the existing tools, technologies, and expertise of your ETL team and internal staff.</li>
</ol></li>
</ol></li>
<li><p><strong>Evaluate your data.</strong></p>
<ol type="a">
<li>Involve everyone in the evaluation and maintenance of ETL and data quality.</li>
<li>Review the ETL design documentation, computer code used in implementation, and concept mappings</li>
<li>Perform a manual audit using a sample of patients from both source data and derived OMOP data</li>
<li>Compare summary level counts of key fields between source data and OMOP derived data. (tools: Achilles)</li>
</ol></li>
</ol>
<p><strong>★ Ask for help along the way!</strong></p>
<p>The CURE ID support team is here to help you. We also encourage you to connect with the OHDSI community to find others with experience, expertise, and guidance for each step of your ETL to OMOP journey. The open, collaborative community of OHDSI is the most powerful tool at your disposal. Use it (us)!</p>
</section>
<section id="places-to-connect" class="level3">
<h3 class="anchored" data-anchor-id="places-to-connect"><u>Places to Connect</u></h3>
<ul>
<li><p>OHDSI.org: https://www.ohdsi.org/</p></li>
<li><p>OHDSI Wiki: https://www.ohdsi.org/web/wiki/doku.php</p></li>
<li><p>OHDSI Forums: https://forums.ohdsi.org/</p></li>
<li><p>OHDSI Workgroups: https://www.ohdsi.org/workgroups/</p></li>
</ul>
</section>
</section>
<section id="omop-cohort-creation-and-de-identification-guide" class="level2">
<h2 class="anchored" data-anchor-id="omop-cohort-creation-and-de-identification-guide">OMOP Cohort Creation and De-identification Guide</h2>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Updated: 7/26/2023</code></pre>
</div>
</div>
<p>The following scripts are to be run on a site’s full OMOP dataset in order to prepare the relevant data for sharing with the VIRUS registry. Each script should be run on the same server as the OMOP data but can be customized to run on the preferred Database and Schema.</p>
<p><strong>Instructions:</strong> Replace the database name and schema in each of these scripts with your own, then run the cohort creation and deidentification scripts in the following sequence:</p>
<section id="concept-table-creation-script" class="level3">
<h3 class="anchored" data-anchor-id="concept-table-creation-script"><u>00 – Concept Table Creation Script</u></h3>
<p><strong>Filename</strong>: <a href="https://github.com/OHDSI/CureIdRegistry/blob/main/Cohort%20curation%20scripts/00_CURE_ID_create_concept_table.sql">00_CURE_ID_create_concept_table.sql)</a></p>
<p><strong>Purpose</strong>: This script creates a table of standard concepts required for the CureID Registry project. It is used in conjunction with CONCEPT_ANCESTOR table in 02_CURE_ID_All_Tables.sql script.</p>
<p><strong>Description</strong>: Fields particularly important to the process are “is_standard” and “include_descendants”.</p>
<p>“is_standard” determines the standardization of the concept, either: a “C”, “S”, or “N” – C is for classification. This concept will not be used, but it may have useable descendants – S is for Standard. These codes will be used. They may or may not have descendants – N is Non-standard. These codes will not be used. If they have descendants</p>
<p>“include_descendants” determines whether the script should look for descendents – Values are either TRUE or FALSE</p>
<p>They will be used in 02_CURE_ID_All_Tables.sql in the FROM clauses: Measurement example: INNER JOIN omop.CONCEPT_ANCESTOR ON descendant_concept_id = m.measurement_concept_id INNER JOIN [Results].[cure_id_concepts] ON ancestor_concept_id = concept_id WHERE domain = ‘Measurement’ AND (include_descendants = ‘TRUE’ OR ancestor_concept_id = descendant_concept_id)</p>
<p>If “include_descendants” is either ‘TRUE’ or if the ancestor_concept_id is the same as descendant_concept_id, the concept will be used. The “is_standard” field is informational only and does not participate in the script.</p>
<p><strong>Dependencies</strong>: None</p>
</section>
<section id="cohort-creation-script" class="level3">
<h3 class="anchored" data-anchor-id="cohort-creation-script"><u>01 – Cohort Creation Script</u></h3>
<p><strong>Filename</strong>: <a href="https://github.com/OHDSI/CureIdRegistry/blob/main/Cohort%20curation%20scripts/01_CURE_ID_Cohort.sql">01_CURE_ID_Cohort.sql</a></p>
<p><strong>Purpose</strong>: This script creates a cohort of patients for the CURE ID registry. The patient list is saved in the cohort table, along with other useful data elements.</p>
<p><strong>Description</strong>: This SQL script creates a cohort of COVID-positive hospitalized patients based on specific criteria. The script performs several steps to identify and filter the patients before finally creating the cohort table. The script sets the context to use a specific database, but the actual name of the database is meant to be provided by the user.</p>
<p><strong>Dependencies</strong>: None</p>
<p><strong>Steps</strong>:</p>
<ol type="1">
<li><p>Create cohort table.</p></li>
<li><p>Identify patients (inpatient and outpatient) with covid positive lab results</p>
<ul>
<li><p>Use OMOP concepts that represent the LOINC codes for SARS-COV-2 nucleic acid test</p></li>
<li><p>The concept ids here represent LOINC or SNOMED codes for standard ways to code a lab that is positive.</p></li>
</ul></li>
<li><p>Identify the first positive covid test per patient (after January 1, 2020).</p></li>
<li><p>Limit to covid-positive patients with inpatient encounters.</p></li>
<li><p>Apply all inclusion/exclusion criteria to identify all patients hospitalized with symptomatic covid-19 up to 21 days after a positive SARS-CoV-2 test or up to 7 days prior to a positive SARS-CoV-2 test</p></li>
<li><p>Find the closest inpatient encounter to first positive SARS-COV-2 test (for patients hospitalized more than once)</p></li>
<li><p>Account for edge cases where patients have two hospitalizations same number of absolute days from SARS-COV-2 test (Ex: Patient hospitalized separately 3 days before and 3 days after SARS-COV-2 test)</p></li>
<li><p>Create the cohort by adding on birth date and death date</p></li>
</ol>
</section>
<section id="cure-id-tables-script" class="level3">
<h3 class="anchored" data-anchor-id="cure-id-tables-script"><u>02 – CURE ID Tables Script</u></h3>
<p><strong>Filename</strong>: <a href="https://github.com/OHDSI/CureIdRegistry/blob/main/Cohort%20curation%20scripts/02_CURE_ID_All_Tables.sql">02_CURE_ID_All_Tables.sql</a></p>
<p><strong>Purpose</strong>: This script takes your OMOP dataset and generates a copy of key tables that have been filtered down to only include people and records related to the CURE ID registry.</p>
<p><strong>Description</strong>: Creates CURE_ID tables from the generated CURE_ID cohort.</p>
<p><strong>Dependencies</strong>: - 01_CURE_ID_Cohort.sql</p>
<p><strong>Steps</strong>:</p>
<ol type="1">
<li><p>Load Person table</p></li>
<li><p>Load Measurements table</p></li>
<li><p>Load Drug Exposure table</p></li>
<li><p>Load Death table</p></li>
<li><p>Load Observation data</p></li>
<li><p>Load Procedure Occurrence Table</p></li>
<li><p>Load Condition Occurrence Table</p></li>
<li><p>Load Visit Occurrence table</p></li>
<li><p>Load Device Exposure tabledb</p></li>
</ol>
</section>
<section id="replace-rare-conditions-script" class="level3">
<h3 class="anchored" data-anchor-id="replace-rare-conditions-script"><u>03 – Replace Rare Conditions Script</u></h3>
<p><strong>Filename</strong>: <a href="https://github.com/OHDSI/CureIdRegistry/blob/main/Cohort%20curation%20scripts/03_CURE_ID_replace_rare_conditions_with_parents.sql">03_CURE_ID_replace_rare_conditions_with_parents.sql</a></p>
<p><strong>Purpose</strong>: Replace conditions occurring 10 or less times in the dataset with parent concepts that have at least 10 counts</p>
<p><strong>Description</strong>: This script is run after scripts 01 and 02</p>
<p><strong>Dependencies</strong>: - 01_CURE_ID_Cohort.sql - 02_CURE_ID_All_Tables.sql</p>
<p><strong>Steps</strong>:</p>
<ol type="1">
<li><p>Condition roll up: concepts are mapped to their corresponding ancestor concept(s)</p></li>
<li><p>Create table that counts the ancestor concepts for each original concept</p></li>
<li><p>Create table that counts the original concepts</p></li>
<li><p>Filter to only include conditions that have more than 10 counts</p></li>
<li><p>Get just the most specific condition in the ancestor-descendent hierarchy</p></li>
</ol>
</section>
<section id="deidentified-data-ddl-script" class="level3">
<h3 class="anchored" data-anchor-id="deidentified-data-ddl-script"><u>04 – Deidentified Data DDL Script</u></h3>
<p><strong>Filename</strong>: <a href="https://github.com/OHDSI/CureIdRegistry/blob/main/Cohort%20curation%20scripts/04_DE_ID_CDM_Table_ddl.sql">04_DE_ID_CDM_Table_ddl.sql</a></p>
<p><strong>Purpose</strong>: Generate the necessary tables for the de-identified version of the CURE ID Cohort</p>
<p><strong>Description</strong>: This script will create tables in the Results schema and preface the table names with ‘deident.’ However, the preface can be set to whatever value you desire.</p>
<p><strong>Dependencies</strong>: None</p>
<p><strong>Steps</strong>:</p>
<ol type="1">
<li><p>Create the Person table</p></li>
<li><p>Create the Death table</p></li>
<li><p>Create the Visit Occurrence table</p></li>
<li><p>Create the Drug Exposure table</p></li>
<li><p>Create the Device Exposure table</p></li>
<li><p>Create the Condition Occurrence table</p></li>
<li><p>Create the Measurement table</p></li>
<li><p>Create the Observation table</p></li>
</ol>
</section>
<section id="deidentification-script" class="level3">
<h3 class="anchored" data-anchor-id="deidentification-script"><u>05 – Deidentification Script</u></h3>
<p><strong>Filename</strong>: <a href="https://github.com/OHDSI/CureIdRegistry/blob/main/Cohort%20curation%20scripts/05_DE_ID_script.sql">05_DE_ID_script.sql</a></p>
<p><strong>Purpose</strong>: This script creates a copy of the Cohort and removes identifying characteristics to prepare the data for sharing with the VIRUS registry.</p>
<p><strong>Description</strong>: Run this script to generate a deidentified copy of your target data. The following actions are performed: - Reassignment of Person IDs: Person IDs are regenerated sequentially from a sorted copy of the Person table. These new Person IDs are carried throughout the CDM to all tables that reference it.</p>
<ul>
<li><p>Date Shifting: Each person is assigned a random date shift value between -186 and +186 days. All dates for that person are then shifted shifted by that amount.</p></li>
<li><p>Birthdays: After date shifting a person’s birthday, the day is then set to the first of the new birth month. If the person would be &gt; 89 years old then they are assigned a random birth year that would make them 90-99 years old.</p></li>
<li><p>Date Truncation: A user-defined Start and End date are used to exclude any date shifted data that falls outside of the target date range (e.g.&nbsp;procedures, conditions occurrences, etc.). Does not include Birthdates.</p></li>
<li><p>Removal of Other Identifiers: Other potentially identifying datapoints are removed from the dataset such as location_id, provider_id, and care_site_id</p></li>
</ul>
<p><strong>Dependencies</strong>: - 01_CURE_ID_Cohort.sql - 02_CURE_ID_All_Tables.sql - 03_CURE_ID_replace_rare_conditions_with_parents.sql - 04_DE_ID_CDM_Table_ddl.sql</p>
<p><strong>Steps</strong>:</p>
<ol type="1">
<li><p>Use find and replace to set source and target DB and Schema names</p></li>
<li><p>Load the OMOP Person table, and de-identify</p></li>
<li><p>Load the OMOP Visit Occurrence table, and de-identify</p></li>
<li><p>Load the OMOP Condition Occurrence table, and de-identify</p></li>
<li><p>Load the OMOP Procedure Occurrence table, and de-identify</p></li>
<li><p>Load the OMOP Drug Exposure table, and de-identify</p></li>
<li><p>Load the OMOP Observation table, and de-identify</p></li>
<li><p>Load the OMOP Death table, and de-identify</p></li>
<li><p>Load the OMOP Device Exposure table, and de-identify</p></li>
<li><p>Load the OMOP Measurement table, and de-identify</p></li>
</ol>
</section>
<section id="quality-checks-script-optional" class="level3">
<h3 class="anchored" data-anchor-id="quality-checks-script-optional"><u>06 – Quality Checks Script (optional)</u></h3>
<p><strong>Filename</strong>: <a href="https://github.com/OHDSI/CureIdRegistry/blob/main/Cohort%20curation%20scripts/06_DE_ID_Quality_Checks.sql">06_DE_ID_Quality_Checks.sql</a></p>
<p><strong>Purpose</strong>: This script checks basic metrics for each table in the deidentified dataset to ensure the previous scripts were successful.</p>
<p><strong>Description</strong>: This script runs a number of summary level quality checks for each table to audit basic data counts and date ranges.</p>
<p><strong>Dependencies</strong>: - 01_CURE_ID_Cohort.sql - 02_CURE_ID_All_Tables.sql - 03_CURE_ID_replace_rare_conditions_with_parents.sql - 04_DE_ID_CDM_Table_ddl.sql - 05_DE_ID_script.sql</p>
<p><strong>Steps</strong>:</p>
<ol type="1">
<li><p>Count distinct person_ids and find the maximum and minimum birthdates in the OMOP Person table.</p></li>
<li><p>Count distinct person_ids in the OMOP Death table.</p></li>
<li><p>Count distinct person_ids, count number of records per observation_concept_id, and find the maximum and minimum observation dates for all records in the OMOP Observation table.</p></li>
<li><p>Count distinct person_ids, count number of records per procedure_concept_id, and find the maximum and minimum procedure dates for all records in the OMOP Procedure Occurrence table.</p></li>
<li><p>Count distinct person_ids, count number of records per condition_concept_id, and find the maximum and minimum condition dates for all records in the OMOP Condition Occurrence table.</p></li>
<li><p>Count distinct person_ids, count number of records per measurement_concept_id, and find the maximum and minimum measurement dates for all records in the OMOP Measurement table.</p></li>
<li><p>Count distinct person_ids, count number of records per device_concept_id, and find the maximum and minimum device exposure dates for all records in the OMOP Device Exposure table.</p></li>
<li><p>Count distinct person_ids, count number of records per drug_concept_id, and find the maximum and minimum drug exposure dates for all records in the OMOP Drug Exposure table.</p></li>
</ol>
</section>
<section id="cohort-profile-scripts" class="level3">
<h3 class="anchored" data-anchor-id="cohort-profile-scripts"><u>07 – Cohort Profile Scripts</u></h3>
<p><strong>Dependencies</strong>: These scripts require the populated deidentified OMOP tables generated from the sequence of running scripts 1-5:</p>
<ul>
<li><p>01_CURE_ID_Cohort.sql</p></li>
<li><p>02_CURE_ID_All_Tables.sql</p></li>
<li><p>03_CURE_ID_replace_rare_conditions_with_parents.sql</p></li>
<li><p>04_DE_ID_CDM_Table_ddl.sql</p></li>
<li><p>05_DE_ID_script.sql</p>
<p>##### 07-A – Condition Profile</p>
<p><strong>Filename</strong>: 07_A_condition_profile.sql</p>
<p><strong>Purpose</strong>: Generate a profile of condition prevalence in the final cohort.</p>
<p><strong>Description</strong>: Condition counts are calculated per patient and are aggregated by parent concepts for each condition concept present in the final OMOP Condition Occurrence table.</p>
<p>##### 07-B – Measurement Profile</p>
<p><strong>Filename</strong>: 07_B_measurement_profile.sql</p>
<p><strong>Purpose</strong>: Generate a profile of measurement prevalence in the final cohort.</p>
<p><strong>Description</strong>: Measurement counts are calculated per patient and are aggregated by parent concepts for each measurement concept present in the final OMOP Measurement table.</p>
<p>##### 07-C – Drug Exposure Profile</p>
<p><strong>Filename</strong>: 07_C_drug_exposure_profile.sql</p>
<p><strong>Purpose</strong>: Generate a profile of drug prevalence in the final cohort.</p>
<p><strong>Description</strong>: Drug counts are calculated per patient and are aggregated by ingredient for each drug concept present in the final OMOP Drug Exposure table.</p>
<p>##### 07-D – Unmapped Drugs Profile</p>
<p><strong>Filename</strong>: 07_D_review_unmapped_drugs.sql</p>
<p><strong>Purpose</strong>: Generate a profile of drugs that are not mapped to drug_concept_ids in the final cohort.</p>
<p><strong>Description</strong>: This file filters drugs that were unsuccessfully mapped to a drug_concept_id when running the 02_CURE_ID_All_Tables.sql script. Drug source values for which the drug_concept_id is “0” and have at least 20 instances in the final cohort are aggregated for manual review. ** Drug source values can contain PHI. Please review the output for PHI before sharing.</p>
<p>##### 07-E – Device Profile</p>
<p><strong>Filename</strong>: 07_E_device_profile.sql</p>
<p><strong>Purpose</strong>: Generate a profile of device prevalence in the final cohort.</p>
<p><strong>Description</strong>: Device counts are calculated per patient and are aggregated by parent concepts for each device concept present in the final OMOP Device Exposure table.</p></li>
</ul>
</section>
</section>
<section id="cure-id-profile-scripts-output-interpretation" class="level2">
<h2 class="anchored" data-anchor-id="cure-id-profile-scripts-output-interpretation">CURE ID Profile Scripts – Output &amp; Interpretation</h2>
<p>This section provides synthetic examples of the output generated from the CURE ID person measurement drug exposure and device profile SQL scripts as well as examples of how to interpret the output from each script.</p>
<section id="a_condition_profile.sql" class="level3">
<h3 class="anchored" data-anchor-id="a_condition_profile.sql">07_A_condition_profile.sql</h3>
<p>Generates a table showing condition prevalence in cohort by individual condition concept.</p>
<p>Example Interpretation</p>
<p>In the highlighted row, the table shows that 6499 patients in the cohort have a recorded diagnosis of hypertension, representing 58% of the total cohort.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Profile_script_7A.png" class="img-fluid figure-img"></p>
<figcaption>Profile_script_7A</figcaption>
</figure>
</div>
</section>
<section id="b_measurement_profile.sql" class="level3">
<h3 class="anchored" data-anchor-id="b_measurement_profile.sql">07_B_measurement_profile.sql</h3>
<p>Generates a table which includes the measurement concepts included in the cohort and their names.</p>
<p>Example Interpretation</p>
<p>The highlighted row shows the distribution of the number of times heart rate was measured per patient in the cohort. 25% of the patients had 17 heart rate measurements or less. 50% of patients had at least 34 heart rate measurements recorded. 75% of patients had at most, 72 heart rate measurements recorded. 95% of patients had at most, 398 heart rate measurements recorded. The four columns can also be interpreted as the median for the bottom 50% (percentile_25), overall median (median), median for the top 50% (percentile_75), and the median for the top 10% (percentile_95) – in terms of how many times the measurement was taken for each patient in the cohort.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Profile_script_7B.png" class="img-fluid figure-img"></p>
<figcaption>Profile_script_7B</figcaption>
</figure>
</div>
</section>
<section id="c_drug_exposure_profile.sql" class="level3">
<h3 class="anchored" data-anchor-id="c_drug_exposure_profile.sql">07_C_drug_exposure_profile.sql</h3>
<p>Generates a table of all drugs given in the cohort.</p>
<p>Example Interpretation</p>
<p>The highlighted row shows that acetaminophen was administered to 7,937 total patients which represents 68% of the patients in the cohort. Acetaminophen was administered an average of 2 times per patient with the highest recorded value of 26 administrations for a single patient.<br>
It is important to note that these are <em>ingredients</em> - which is why sodium chloride is the most frequent “drug” because most IV drugs contain sodium chloride as an ingredient.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Profile_script_7C.png" class="img-fluid figure-img"></p>
<figcaption>Profile_script_7C</figcaption>
</figure>
</div>
</section>
<section id="e_device_profile.sql" class="level3">
<h3 class="anchored" data-anchor-id="e_device_profile.sql">07_E_device_profile.sql</h3>
<p>Generates a table which includes the device concepts included in the cohort and their counts.</p>
<p>Example Interpretation</p>
<p>The highlighted row shows that an oxygen nasal cannula device was used for 9,238 patients in the cohort. That patients count represents 44% of the total cohort. Use of this device was recorded an average of 225.3 times per patient, with a maximum of 7,239 recordings for a single patient, when counting all flowsheet entries.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Profile_script_7E.png" class="img-fluid figure-img"></p>
<figcaption>Profile_script_7E</figcaption>
</figure>
</div>
</section>
</section>
<section id="omop-table-and-field-basics" class="level2">
<h2 class="anchored" data-anchor-id="omop-table-and-field-basics">OMOP Table and Field Basics</h2>
<p>Adapted from OHDSI CDM Site: <a href="https://ohdsi.github.io/CommonDataModel/dataModelConventions.html">Data Model Conventions</a>&nbsp;</p>
<section id="tables" class="level4">
<h4 class="anchored" data-anchor-id="tables">Tables</h4>
<p>For the tables of the main domains of the CDM it is imperative that concepts used are strictly limited to the domain. For example, the CONDITION_OCCURRENCE table contains only information about conditions (diagnoses, signs, symptoms), but no information about procedures. Not all source coding schemes adhere to such rules. For example, ICD-9-CM codes, which contain mostly diagnoses of human disease, also contain information about the status of patients having received a procedure. The ICD-9-CM code V20.3 ‘Newborn health supervision’ defines a continuous procedure and is therefore stored in the PROCEDURE_OCCURRENCE table.</p>
</section>
<section id="fields" class="level4">
<h4 class="anchored" data-anchor-id="fields">Fields</h4>
<p>Variable names across all tables follow one convention:</p>
<table class="caption-top table">
<tbody>
<tr class="odd">
<td><strong>Notation</strong></td>
<td><strong>Description</strong></td>
</tr>
<tr class="even">
<td>_SOURCE_VALUE</td>
<td>Verbatim information from the source data, typically used in ETL to map to CONCEPT_ID, and not to be used by any standard analytics. For example, CONDITION_SOURCE_VALUE = ‘787.02’ was the ICD-9 code captured as a diagnosis from the administrative claim.</td>
</tr>
<tr class="odd">
<td>_ID</td>
<td>Unique identifiers for key entities, which can serve as foreign keys to establish relationships across entities. For example, PERSON_ID uniquely identifies each individual. VISIT_OCCURRENCE_ID uniquely identifies a PERSON encounter at a point of care.</td>
</tr>
<tr class="even">
<td>_CONCEPT_ID</td>
<td>Foreign key into the Standardized Vocabularies (i.e.&nbsp;the standard_concept attribute for the corresponding term is true), which serves as the primary basis for all standardized analytics. For example, CONDITION_CONCEPT_ID = <a href="http://athena.ohdsi.org/search-terms/terms/31967">31967</a> contains the reference value for the SNOMED concept of ‘Nausea’</td>
</tr>
<tr class="odd">
<td>_SOURCE_CONCEPT_ID</td>
<td>Foreign key into the Standardized Vocabularies representing the concept and terminology used in the source data, when applicable. For example, CONDITION_SOURCE_CONCEPT_ID = <a href="http://athena.ohdsi.org/search-terms/terms/45431665">45431665</a> denotes the concept of ‘Nausea’ in the Read terminology; the analogous CONDITION_CONCEPT_ID might be 31967, since SNOMED-CT is the Standardized Vocabulary for most clinical diagnoses and findings.</td>
</tr>
<tr class="even">
<td>_TYPE_CONCEPT_ID</td>
<td>Delineates the origin of the source information, standardized within the Standardized Vocabularies. For example, DRUG_TYPE_CONCEPT_ID can allow analysts to discriminate between ‘Pharmacy dispensing’ and ’Prescription written</td>
</tr>
</tbody>
</table>
<p>For more information, see:</p>
<p><a href="https://ohdsi.github.io/CommonDataModel/dataModelConventions.html#Data_Model_Conventions">Data Model Conventions</a></p>
<p><a href="https://ohdsi.github.io/CommonDataModel/drug_dose.html">How to Calculate Drug Dose</a>&nbsp;</p>
<p><a href="https://ohdsi.github.io/CommonDataModel/cdm53.html#Clinical_Data_Tables">Clinical Data Tables</a>&nbsp;</p>
</section>
</section>
<section id="cure-id-concept-mapping-support" class="level1">
<h1>Cure ID Concept Mapping Support</h1>
<p><img src="images/CureID_Concept_Mapping_Process.png" class="img-fluid"></p>
<section id="collaborative-omop-concept-mapping-process" class="level4">
<h4 class="anchored" data-anchor-id="collaborative-omop-concept-mapping-process">Collaborative OMOP Concept Mapping Process</h4>
<ol type="1">
<li><p>CureID clinical informaticists work with each site to manually map internal concepts to OMOP concepts outlined for capture in the project plan.</p></li>
<li><p>The combined concepts from all sites are maintained as a single, updated concept set using the OHDSI ATLAS open-source tool.</p></li>
<li><p>All concepts currently identified by the work between CureID staff and each site, and all corresponding descendant concepts are exported from ATLAS as .json or .csv files for use in cohort creation, profiling, and clinical registry submission.</p></li>
</ol>
</section>
</section>
<section id="identifying-oxygen-devices-in-epicclarity" class="level1">
<h1>Identifying Oxygen Devices in Epic/Clarity</h1>
<p><a href="https://userweb.epic.com/Thread/118440/Identifying-Oxygen-Devices-Flowsheet-Measures-to-Map-to-OMOP/">Identifying Oxygen Devices Flowsheet Measures to Map to OMOP Concepts</a></p>
</section>
<section id="geocoding-and-integrating-sdoh-data" class="level1">
<h1>Geocoding and Integrating SDOH Data</h1>
<p>To link geocoded addresses to the Neighborhood Atlas for getting the Area Deprivation Index (ADI) for patients in a dataset, you will typically follow these steps:</p>
<ol type="1">
<li>Prepare Your Dataset Patient Data: Ensure you have a dataset of patients with addresses. This data should be anonymized to protect patient privacy. Geocoding: Each address needs to be geocoded. Geocoding is the process of converting addresses into geographic coordinates (latitude and longitude).</li>
<li>Geocoding Addresses Use a Geocoding Service: Tools like Google Maps API, ArcGIS, or OpenStreetMap can be used to geocode addresses. This will give you the precise geographic location for each address. Accuracy Check: Ensure the geocoding is accurate. Incorrect geocoding can lead to wrong ADI assignments.</li>
<li>Understanding the Neighborhood Atlas ADI Overview: The ADI is a measure developed by the Neighborhood Atlas. It provides a ranked and searchable list of neighborhoods according to their level of disadvantage. Data Format: Understand the format of the Neighborhood Atlas data. It typically includes geographical identifiers like census tracts.</li>
<li>Linking Geocoded Data to the Neighborhood Atlas Match Coordinates with Census Tracts: Use the geographic coordinates to determine the corresponding census tract for each patient. This can be done using GIS software like ArcGIS or QGIS. Cross-Reference with ADI Data: Once you have the census tract for each patient, cross-reference these with the Neighborhood Atlas to find the ADI for each tract.</li>
<li>Integrating ADI into Your Dataset Add ADI to Patient Records: For each patient, add the ADI corresponding to their census tract. This step integrates socioeconomic context into your patient data.</li>
</ol>
<section id="geocoding" class="level3">
<h3 class="anchored" data-anchor-id="geocoding">Geocoding</h3>
<p>The primary consideration for linking geospatial data like social determinants of health and environmental risk factors with patient data is protecting PHI when geocoding patient home address and location data. Do not use web-based API services for geocoding as they require patient addresses to be sent to an external server for batch geocoding. Geocoding will require software that can match patient addresses to the appropriate shapefiles to determine a precise location and output latitudinal/longitudinal coordinates. Two software solutions for geocoding include: - Use ESRI ArcGIS or a similar program that can perform geocoding locally and has all appropriate shapefiles downloaded. This software is expensive, but many institutions have a license already in place. - Install geocoding software (ex: open-source, Degauss geocoder: https://www.degauss.org/geocoder) locally via manual installation or by installing a docker container.</p>
</section>
<section id="area-deprivation-index" class="level3">
<h3 class="anchored" data-anchor-id="area-deprivation-index">Area Deprivation Index</h3>
<p>The Area Deprivation Index (ADI) is based on a measure created by the Health Resources &amp; Services Administration (HRSA) over three decades ago, and has since been refined, adapted, and validated to the Census block group neighborhood level by Amy Kind, MD, PhD and her research team at the University of Wisconsin-Madison. It allows for rankings of neighborhoods by socioeconomic disadvantage in a region of interest (e.g., at the state or national level). It includes factors for the theoretical domains of income, education, employment, and housing quality. It can be used to inform health delivery and policy, especially for the most disadvantaged neighborhood groups. “Neighborhood” is defined as a Census block group.<br>
from: https://www.neighborhoodatlas.medicine.wisc.edu/</p>
</section>
<section id="adi-as-an-ohdsi-concept" class="level3">
<h3 class="anchored" data-anchor-id="adi-as-an-ohdsi-concept">ADI as an OHDSI Concept</h3>
<p>ADI is not included as an explicit concept in any of the appropriate standard vocabularies. The OHDSI Vocabularies Team recommended that this information be included in the OMOP data as a custom concept in the Observation table. The workflow will be simply to add a line item to the concept mapping table for Area Deprivation Index like the following example: concept_id = 2000000999 concept_code = NA concept_name = Area deprivation index domain = observation vocabulary = Custom is_standard = C include_descendents = False</p>
</section>
</section>
<section id="ohdsi-tool-suite" class="level1">
<h1>OHDSI Tool Suite</h1>
<p>The Edge Tool Suite are a set of OHDSI tools that should be deployed by the site that provide value around the OMOP CDM. This work was funded by the CURE ID initiative <a href="https://cure.ncats.io" class="uri">https://cure.ncats.io</a></p>
<p>The OHDSI open source software configured for deployment include:</p>
<ul>
<li><p>The Atlas data science platform</p></li>
<li><p>The WebAPI backed for Atlas</p></li>
<li><p>The HADES statistical analysis packages</p></li>
<li><p>The Data Quality Dashboard</p></li>
<li><p>The Perseus ETL management system</p></li>
</ul>
<section id="simplifying-the-etl-process" class="level4">
<h4 class="anchored" data-anchor-id="simplifying-the-etl-process">Simplifying the ETL process</h4>
<p>The OHDSI community has created a series of individual software packages to facilitate the ETL from proprietary EHRs to OMOP, evaluate data quality, define cohorts, and perform analyses. The “Edge Tool” packages these individual tools to facilitate the performance of an OMOP ETL and subsequent use of the data for defining cohorts for observational research. In contrast to registry approaches which ingest data represented in various data models and perform data harmonization centrally, software components of the “Edge Tool” facilitate ETL performance locally at the “edge.” This suite of software aims to drastically reduce the labor and effort required to go from “zero to OMOP.” We anticipate that institutions that use the full suite of offered software will be able to reduce the person-hours required for an OMOP ETL to as little as 50 hours.</p>
</section>
<section id="software-components" class="level4">
<h4 class="anchored" data-anchor-id="software-components">Software components</h4>
<p>The Edge Tool encompasses the Perseus ETL management solution, the HADES R analysis package within an RStudio Server R integrated development environment, and the ATLAS cohort discovery tool with WebAPI web services integration (Figure). The Perseus graphic-user interface (GUI) approach provides source-to-concept mapping for the ETL, with assisted extraction of data from EHR such as flowsheets (vital signs, nursing assessments), test measurements, and diagnoses. Rather than performing a series of SQL queries with wildcards to identify data elements of interest from primary source EHR tables,users may enter desired data element terms into a browser text field which are then matched using term similarity to source table entries.Users may then evaluate the completeness and quality of the ETL using the Data Quality Dashboard which performs &gt;3,000 individual data quality checks on the OMOP-formatted data and is reported through a web-based reporting system.</p>
<p>In tandem with Perseus, OHDSI HADES and OHDSI ATLAS are the two projects within the Edge Tool that allow for advanced analysis once data has been harmonized with the OMOP CDM, such as generating cohorts for research, patient level prediction, treatment pathways, large scale population analytics, automated reporting and, optionally, participation in OHDSI network studies.The OHDSI applications within the Edge Tool have been containerized using OHDSI Broadsea, allowing for even easier deployment. Current use of the Edge Tool has proven promising and while limitations still exist - e.g., not currently capable of extracting data from unstructured fields such as notes or loose text - further process optimization and tool development will reduce this implementation time and effort further.</p>
</section>
<section id="ways-to-deploy-the-software" class="level4">
<h4 class="anchored" data-anchor-id="ways-to-deploy-the-software">Ways to deploy the software</h4>
<ol type="1">
<li>Cloud vendor software configured for use.</li>
</ol>
<p><a href="https://github.com/microsoft/OHDSIonAzure">OHDSI on Azure (Includes Perseus, Atlas, and Hades)</a></p>
<p><a href="https://github.com/OHDSI/OHDSIonAWS">OHDSI on AWS (Includes Atlas and Hades)</a></p>
<ol start="2" type="1">
<li>Broadsea provides a set of docker containers that ease the cost of implementation</li>
</ol>
<p><a href="https://github.com/OHDSI/Broadsea">Broadsea (Includes Atlas and Hades)</a></p>
<ol start="3" type="1">
<li>Sites can compile the tools from the source repositories</li>
</ol>
</section>
<section id="ohdsi-specific" class="level4">
<h4 class="anchored" data-anchor-id="ohdsi-specific">OHDSI Specific</h4>
<p><a href="https://github.com/OHDSI/CommonDataModel" class="uri">https://github.com/OHDSI/CommonDataModel</a></p>
<p><a href="https://github.com/OHDSI/Broadsea" class="uri">https://github.com/OHDSI/Broadsea</a></p>
<p><a href="https://github.com/OHDSI/Athena" class="uri">https://github.com/OHDSI/Athena</a></p>
</section>
<section id="the-etl-process" class="level4">
<h4 class="anchored" data-anchor-id="the-etl-process">The ETL Process</h4>
<p><a href="https://github.com/OHDSI/Perseus" class="uri">https://github.com/OHDSI/Perseus</a></p>
<p><a href="https://github.com/OHDSI/WhiteRabbit" class="uri">https://github.com/OHDSI/WhiteRabbit</a></p>
<p><a href="https://github.com/OHDSI/Usagi" class="uri">https://github.com/OHDSI/Usagi</a></p>
</section>
<section id="atlas-and-cohort-discovery" class="level4">
<h4 class="anchored" data-anchor-id="atlas-and-cohort-discovery">ATLAS and Cohort Discovery</h4>
<p><a href="https://github.com/OHDSI/Atlas" class="uri">https://github.com/OHDSI/Atlas</a></p>
<p><a href="https://github.com/OHDSI/WebAPI" class="uri">https://github.com/OHDSI/WebAPI</a></p>
</section>
<section id="broadsea" class="level4">
<h4 class="anchored" data-anchor-id="broadsea">Broadsea</h4>
<p><a href="https://www.youtube.com/watch?v=a9ZJURNRbUg" class="uri">https://www.youtube.com/watch?v=a9ZJURNRbUg</a></p>
</section>
<section id="data-analysis" class="level4">
<h4 class="anchored" data-anchor-id="data-analysis">Data Analysis</h4>
<p><a href="https://github.com/OHDSI/Achilles" class="uri">https://github.com/OHDSI/Achilles</a></p>
<p><a href="https://github.com/OHDSI/Hades" class="uri">https://github.com/OHDSI/Hades</a></p>
<p><a href="https://github.com/OHDSI/DataQualityDashboard" class="uri">https://github.com/OHDSI/DataQualityDashboard</a></p>
</section>
</section>
<section id="best-practices" class="level1">
<h1>Best Practices</h1>
<p>Data Quality Dos and Don’ts</p>
<ul>
<li><p>Do install the Data Quality Dashboard early on in the process.</p></li>
<li><p>Don’t include source values in your export - they might include PHI.</p></li>
<li><p>Don’t forget to check GitHub for the most recent version of the script before you run it.</p></li>
<li><p>Don’t send your data to the coordinating center until the tech team has a chance to review it with you in a live session.</p></li>
<li><p>Duplicated results have been reported at some sites when running script 02_CURE_ID_ALL_Tables.sql. However, at this time no root cause has been found. There is some belief that adding DISTINCT to the various SELECT statements could resolve the issue, while there is some concern over the latest updates to script 00_CURE_ID_create_concept_table.sql as it has standard concepts as well as standard descendants. Be sure to review your data carefully and report any signs of duplication so that it can be investigated.</p></li>
</ul>
</section>
<section id="manuscripts" class="level1">
<h1>Manuscripts</h1>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10072311/pdf/cc9-5-e0893.pdf">Heavner SF, Anderson W, Kashyap R, Dasher P, Mathé EA, Merson L, Guerin PJ, Weaver J, Robinson M, Schito M, Kumar VK, Nagy P. A Path to Real-World Evidence in Critical Care Using Open-Source Data Harmonization Tools. Crit Care Explor. 2023 Apr 3;5(4):e0893. doi: 10.1097/CCE.0000000000000893. PMID: 37025303; PMCID: PMC10072311.</a></p>
</section>
<section id="webinars" class="level1">
<h1>Webinars</h1>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/H8Ur1xzVjS0" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</section>
<section id="omop-scripts-for-epic" class="level1">
<h1>OMOP Scripts for Epic</h1>
<p><a href="https://userweb.epic.com/User/788dbdff-6712-4b16-aabc-98cdb1be4ff9">“The Spectrum Code”</a>: scripts and documentation created by Roger Carlson at Corewell Health</p>
<p><a href="https://userweb.epic.com/User/788dbdff-6712-4b16-aabc-98cdb1be4ff9">RUMC OMOP transition scripts from Clarity, Caboodle</a>: Code created by Rush University Medical Center</p>
</section>
<section id="using-synthetic-data" class="level1">
<h1>Using synthetic data</h1>
<p><a href="https://physionet.org/content/mimic-iv-demo-omop/0.9/1_omop_data_csv/#files-panel">MIMIC-IV</a> 100-patient demo dataset based on MIMIC to create a OMOP instance</p>
<p><a href="https://github.com/OHDSI/ETL-Synthea">Synthea</a> GitHub site with files to use the synthetic patient generator Synthea</p>
<p><a href="https://ohdsi.github.io/Eunomia/">Eunomia</a> LInk to the Eunomia GitHub.io site with instructions and standard dataset files</p>
</section>
<section id="useful-resources" class="level1">
<h1>Useful Resources</h1>
<p><a href="https://www.ohdsi.org/">Web site for the OHDSI community</a>: http://www.ohdsi.org</p>
<p><a href="https://ohdsi.github.io/TheBookOfOhdsi/">The Book of OHDSI:</a> What is OHDSI and why should I care?</p>
<p><a href="https://academy.ehden.eu/">EHDEN Academy</a> : EHDEN Academy is a site with courses for developing skills working with OHDSI</p>
<p><a href="https://www.youtube.com/playlist?list=PLpzbqK7kvfeXRQktX0PV-cRpb3EFA2e7Z">Tutorials &amp; Workshops</a> : Tutorial sessions 1-8 provide a comprehensive overview from vocabularies and creating cohorts to prediction</p>
<p><a href="https://forums.ohdsi.org/">OHDSI Forums</a> : Searchable, active user community</p>
<p><a href="https://dash.ohdsi.org/">OHDSI Community Dashboard</a> : Tracks publications, citations, researchers and activity within the OHDSI community</p>
<p><a href="https://www.youtube.com/watch?v=HhQ9x3bsv4o">Clinical Registry Efforts Within OHDSI (Sept.&nbsp;13 Community Call)</a>: Video discussing Perseus and Broadsea</p>
<p><a href="https://github.com/OHDSI/OHDSI-in-a-Box">OHDSI-in-a-Box on GitHub</a> : A learning environment created for the OHDSI community</p>
<p><a href="https://arxiv.org/ftp/arxiv/papers/2109/2109.08235.pdf">Integrating Flowsheet Data in OMOP Common Data Model for Clinical Research</a> Paper written by informatics teams at Stanford University and The Hospital for Sick Children</p>
<p><a href="https://ohdsi.github.io/CommonDataModel/cdmPrivacy.html">Guide to privacy issues in OMOP journey</a>: Article outlining how to manage protected health information</p>
<p><a href="https://github.com/OHDSI/DataQualityDashboard">DQD</a> GitHub repository for Data Quality Dashboard tool</p>
<p><a href="https://phekb.org/phenotypes">PheKB</a> A phenotype repository</p>
<p><a href="https://learn.microsoft.com/en-us/azure/architecture/example-scenario/digital-health/patient-data-ohdsi-omop-cdm">Analyze observational patient data by using OHDSI with the OMOP CDM</a> Microsoft guide to OMOP CDM</p>
<p><a href="https://github.com/microsoft/OHDSIonAzure">OHDSI on Azure GitHub</a> Automation code and documentation for deploying OHDSI CDM in Azure</p>
<p><a href="https://github.com/OHDSI/Perseus">OHDSI/Perseus GitHub site</a> OHDSI/Perseus on GitHub</p>
<p><a href="https://www.ohdsi.org/2022showcase-79/">How to develop capacity for observational research within a health system</a> Presentation on building capacity from 2022 OHDSI Collaborator Showcase</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>